<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const moeda = (v) =>
  v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

function toNumber(v) {
  return parseFloat((v || "0").replace(",", ".")) || 0;
}

// ===== GRÁFICO MENSAL =====

let grafico;

function lerDadosMes(mes) {
  const dias = {};

  Object.keys(localStorage).forEach((key) => {

    if (!key.startsWith("planeta_")) return;

    const data = key.replace("planeta_", "");
    if (!data.startsWith(mes)) return;

    const dia = data.slice(-2);
    const registros = JSON.parse(localStorage.getItem(key)) || [];

    if (!dias[dia]) dias[dia] = { entradas: 0, saidas: 0 };

    registros.forEach(r => {
      dias[dia].entradas += toNumber(r.entrada);
      dias[dia].saidas += toNumber(r.saida);
    });

  });

  return dias;
}

function atualizarGrafico() {

  const data = document.getElementById("data").value;
  const mes = data.slice(0, 7);

  const dadosMes = lerDadosMes(mes);

  const labels = Object.keys(dadosMes).sort((a,b)=>a-b);
  const entradas = labels.map(d => dadosMes[d].entradas);
  const saidas = labels.map(d => dadosMes[d].saidas);

  const totalEntradas = entradas.reduce((a,b)=>a+b,0);
  const totalSaidas = saidas.reduce((a,b)=>a+b,0);

  document.getElementById("totalEntradasMes").innerText = moeda(totalEntradas);
  document.getElementById("totalSaidasMes").innerText = moeda(totalSaidas);

  const ctx = document.getElementById("grafico");

  if (grafico) grafico.destroy();

  grafico = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Entradas",
          data: entradas,
          backgroundColor: "green"
        },
        {
          label: "Saídas",
          data: saidas,
          backgroundColor: "red"
        }
      ]
    },
    options: {
      plugins: {
        legend: { labels
