<script>
const mesInput = document.getElementById("mes");
let grafico;

const moeda = (v) =>
  v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

function toNumber(v) {
  return parseFloat((v || "0").replace(",", ".")) || 0;
}

function gerarDadosMes(mes) {
  let dias = {};
  let totalEntradas = 0;
  let totalSaidas = 0;

  Object.keys(localStorage).forEach((k) => {
    if (k.startsWith("planeta_" + mes)) {
      const dados = JSON.parse(localStorage.getItem(k)) || [];
      const dia = k.slice(-2);

      if (!dias[dia]) dias[dia] = { entradas: 0, saidas: 0 };

      dados.forEach(l => {
        const e = toNumber(l.entrada);
        const s = toNumber(l.saida);

        dias[dia].entradas += e;
        dias[dia].saidas += s;

        totalEntradas += e;
        totalSaidas += s;
      });
    }
  });

  document.getElementById("totalEntradas").innerText = moeda(totalEntradas);
  document.getElementById("totalSaidas").innerText = moeda(totalSaidas);

  return dias;
}

function desenharGrafico(mes) {
  const dadosMes = gerarDadosMes(mes);

  const labels = Object.keys(dadosMes).sort((a,b)=>a-b);
  const entradas = labels.map(d => dadosMes[d].entradas);
  const saidas = labels.map(d => dadosMes[d].saidas);

  const ctx = document.getElementById("grafico");

  if (grafico) grafico.destroy();

  grafico = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Entradas",
          data: entradas,
        },
        {
          label: "SaÃ­das",
          data: saidas,
        }
      ]
    }
  });
}

const hoje = new Date().toISOString().slice(0, 7);
mesInput.value = hoje;

mesInput.addEventListener("change", () => {
  desenharGrafico(mesInput.value);
});

desenharGrafico(hoje);
</script>
